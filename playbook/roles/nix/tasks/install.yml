---
- name: Check if Nix was installed
  ansible.builtin.stat:
    path: "~/.nix-profile/bin/nix"
  register: nix_installed
  tags:
    - install

- name: Install Nix
  when: not nix_installed.stat.exists
  tags:
    - install
  block:
    - name: Download Nix archive
      ansible.builtin.get_url:
        url: "{{ nix_install_url }}"
        dest: "{{ nix_dest_download_path }}"
        mode: '0644'

    - name: Unpack nix
      ansible.builtin.unarchive:
        src: "{{ nix_dest_download_path }}"
        dest: /tmp/
        remote_src: true
        extra_opts: [--no-same-owner]

    - name: Set SELinux mode to permissive
      become: true
      ansible.builtin.command: setenforce 0
      ignore_errors: true

    - name: Install Nix
      ansible.builtin.command: /tmp/{{ nix_download_file_name }}/install --daemon --yes

    - name: Set SELinux file contexts for Nix
      become: true
      ansible.builtin.command: "sudo semanage fcontext -a -t {{ item.setype }} '{{ item.target }}'"
      loop: "{{ semanage_rules }}"

    - name: Copy Nix SELinux policy template
      become: true
      ansible.builtin.template:
        src: selinux_nix.te
        dest: /tmp/{{ nix_selinux_policy_name }}.te
        mode: '0644'

    - name: Compile SELinux policy
      become: true
      ansible.builtin.command: checkmodule -M -m -o /tmp/{{ nix_selinux_policy_name }}.mod /tmp/{{ nix_selinux_policy_name }}.te
      args:
        creates: /tmp/{{ nix_selinux_policy_name }}.mod

    - name: Create SELinux policy package
      become: true
      ansible.builtin.command: semodule_package -o /tmp/{{ nix_selinux_policy_name }}.pp -m /tmp/{{ nix_selinux_policy_name }}.mod
      args:
        creates: /tmp/{{ nix_selinux_policy_name }}.pp

    - name: Install SELinux policy
      become: true
      ansible.builtin.command: semodule -i /tmp/{{ nix_selinux_policy_name }}.pp
      register: selinux_result
      changed_when: selinux_result.rc == 0

    - name: Verify SELinux policy installation
      become: true
      ansible.builtin.command: semodule -l
      register: semodule_list
      changed_when: false

    - name: Debug installed SELinux policies
      ansible.builtin.debug:
        msg: "{{ semodule_list.stdout_lines | select('search', 'nix') | list }}"

    - name: Relabel file system
      become: true
      ansible.builtin.command: restorecon -R /nix

    - name: Set SELinux mode to enforce
      become: true
      ansible.builtin.command: setenforce 1

    - name: Enable nix-command and flakes globally
      become: true
      ansible.builtin.lineinfile:
        path: "{{ nix_conf_path }}"
        line: "experimental-features = nix-command flakes"
        create: true

    - name: Restart Nix daemon
      become: true
      ansible.builtin.systemd:
        name: nix-daemon.service
        state: restarted
        enabled: true

    - name: Check Nix
      ansible.builtin.command: |
        . /etc/profile.d/nix.sh
        nix --version

        nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
        nix-channel --update nixpkgs
        nix-shell --packages nodejs --run "node -v"
